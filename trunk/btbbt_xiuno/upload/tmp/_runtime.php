<?php
 class core { public static function gpc($k, $var = 'G') { switch($var) { case 'G': $var = &$_GET; break; case 'P': $var = &$_POST; break; case 'C': $var = &$_COOKIE; break; case 'R': $var = isset($_GET[$k]) ? $_GET : (isset($_POST[$k]) ? $_POST : $_COOKIE); break; case 'S': $var = &$_SERVER; break; } return isset($var[$k]) ? $var[$k] : NULL; } public static function conf($key, $appname = '') { global $conf; if(isset($conf[$appname][$key])) { return $conf[$appname][$key]; } else { return NULL; } } public static function addslashes(&$var) { if(is_array($var)) { foreach($var as $k=>&$v) { self::addslashes($v); } } else { $var = addslashes($var); } } public static function stripslashes(&$var) { if(is_array($var)) { foreach($var as $k=>&$v) { self::stripslashes($v); } } else { $var = stripslashes($var); } } public static function is_cmd() { return !isset($_SERVER['REMOTE_ADDR']); } public static function ob_start() { if(!DEBUG && !ini_get('zlib.output_compression') && function_exists('crc32') && function_exists('gzcompress') && strpos(core::gpc('HTTP_ACCEPT_ENCODING', 'S'), 'gzip') !== FALSE) { ob_start('ob_gzhandler'); } else { ob_start(); } } public static function init_set() { if(DEBUG) { error_reporting(E_ALL | E_STRICT); ini_set('display_error', 'ON'); } else { error_reporting(E_ALL & ~E_NOTICE); } @set_magic_quotes_runtime(0); PHP_VERSION < '5.0' && exit('Required PHP version 5.0.* or later.'); } public static function init_supevar() { unset($_ENV, $HTTP_GET_VARS, $HTTP_POST_VARS, $HTTP_COOKIE_VARS, $HTTP_SERVER_VARS, $HTTP_ENV_VARS); $_SERVER['starttime'] = microtime(1); $_SERVER['time'] = isset($_SERVER['REQUEST_TIME']) ? $_SERVER['REQUEST_TIME'] : time(); $_SERVER['ip'] = isset($_SERVER['REMOTE_ADDR']) ? $_SERVER['REMOTE_ADDR'] : ''; $_SERVER['sqls'] = array(); !isset($_SERVER['REQUEST_URI']) && self::fix_iis_request(); $_GET = array(); self::init_get(); } public static function init_handle() { spl_autoload_register(array('core', 'autoload_handle')); set_exception_handler(array('core', 'exception_handle')); if(DEBUG || core::gpc('ajax', 'R')) { set_error_handler(array('core', 'error_handle')); } } public static function autoload_handle($classname) { $libclasses = ' check, log, misc, form, utf8, image, template, db_mysql, db_mongodb, db_pdo, db_file, db_ttserver, cache_apc, cache_ea, cache_memcache, cache_redis, cache_xcache, json_data, '; if(strpos($libclasses, ' '.$classname.', ') !== FALSE) { include FRAMEWORK_PATH.'lib/'.$classname.'.class.php'; return class_exists($classname, false) || interface_exists($classname, false); } else { global $conf; if(!class_exists($classname)) { foreach($conf['model_path'] as $path) { if(is_file($path."$classname.class.php")) { include_once $path."$classname.class.php"; } } } if(!class_exists($classname, false)) { throw new Exception('class '.$classname.' does not exists.'); } } return true; } public static function exception_handle($e) { DEBUG && $_SERVER['exception'] = 1; log::write($e->getMessage().' File: '.$e->getFile().' ['.$e->getLine().']', 'phperror.php'); $s = ''; if(DEBUG) { try { if(self::gpc('ajax', 'R')) { $s = xn_exception::to_json($e); } else { $s = xn_exception::to_html($e); } } catch (Exception $e) { $s = get_class($e)." thrown within the exception handler. Message: ".$e->getMessage()." on line ".$e->getLine(); } } else { if(self::gpc('ajax', 'R')) { $s = core::json_encode(array('servererror'=>$e->getMessage())); } else { $s = $e->getMessage(); } } echo $s; exit; } public static function error_handle($errno, $errstr, $errfile, $errline) { $errortype = array ( E_ERROR => 'Error', E_WARNING => 'Warning', E_PARSE => 'Parsing Error', E_NOTICE => 'Notice', E_CORE_ERROR => 'Core Error', E_CORE_WARNING => 'Core Warning', E_COMPILE_ERROR => 'Compile Error', E_COMPILE_WARNING => 'Compile Warning', E_USER_ERROR => 'User Error', E_USER_WARNING => 'User Warning', E_USER_NOTICE => 'User Notice', E_STRICT => 'Runtime Notice', ); $errnostr = isset($errortype[$errno]) ? $errortype[$errno] : 'Unknonw'; $s = "[$errnostr] : $errstr in File $errfile, Line: $errline"; if(DEBUG && empty($_SERVER['exception'])) { throw new Exception($s); } else { log::write($s, 'phperror.php'); $s = preg_replace('# \S*[/\\\\](.+?\.php)#', ' \\1', $s); if(self::gpc('ajax', 'R')) { ob_end_clean(); echo self::json_encode(array('servererror'=>$s)); exit; } else { echo $s; } } return 0; } private static function fix_iis_request() { if(isset($_SERVER['HTTP_X_REWRITE_URL'])) { $_SERVER['REQUEST_URI'] = $_SERVER['HTTP_X_REWRITE_URL']; } else if(isset($_SERVER['HTTP_REQUEST_URI'])) { $_SERVER['REQUEST_URI'] = $_SERVER['HTTP_REQUEST_URI']; } else { if(isset($_SERVER['SCRIPT_NAME'])) { $_SERVER['HTTP_REQUEST_URI'] = $_SERVER['SCRIPT_NAME']; } else { $_SERVER['HTTP_REQUEST_URI'] = $_SERVER['PHP_SELF']; } if(isset($_SERVER['QUERY_STRING'])) { $_SERVER['REQUEST_URI'] = '?' . $_SERVER['QUERY_STRING']; } elseif(isset($_SERVER['HTTP_REQUEST_URI'])) { $_SERVER['REQUEST_URI'] = $_SERVER['HTTP_REQUEST_URI']; } else { $_SERVER['REQUEST_URI'] = ''; } } } private static function init_get() { $r = $_SERVER['REQUEST_URI']; $get = &$_GET; $r = substr($r, strrpos($r, '/') + 1); substr($r, 0, 9) == 'index.php' && $r = substr($r, 9); substr($r, 0, 1) == '?' && $r = substr($r, 1); $r = str_replace('.htm&', '?', $r); $r = str_replace('.htm?', '?', $r); $sep = strpos($r, '?'); $s1 = $s2 = ''; if($sep !== FALSE) { $s1 = substr($r, 0, $sep); $s2 = substr($r, $sep + 1); } else { $s1 = $r; $s2 = ''; if(substr($s1, -4) == '.htm') { $s1 = substr($s1, 0, -4); } else { $s2 = $s1; $s1 = ''; } } $arr1 = $arr2 = array(); $s1 && $arr1 = explode('-', $s1); parse_str($s2, $arr2); $get += $arr1; $get += $arr2; $num = count($arr1); if($num > 2) { for($i=2; $i<$num; $i+=2) { isset($arr1[$i+1]) && $get[$arr1[$i]] = urldecode($arr1[$i+1]); } } $get[0] = isset($get[0]) && preg_match("/^\w+$/", $get[0]) ? $get[0] : 'index'; $get[1] = isset($get[1]) && preg_match("/^\w+$/", $get[1]) ? $get[1] : 'index'; } public static function init() { core::init_set(); core::init_supevar(); core::init_handle(); if(get_magic_quotes_gpc()) { core::stripslashes($_GET); core::stripslashes($_POST); core::stripslashes($_COOKIE); } if(!core::is_cmd()) { header('Content-Type: text/html; charset=UTF-8'); header("Expires: 0"); header("Cache-Control: private, post-check=0, pre-check=0, max-age=0"); header("Pragma: no-cache"); } } public static function process_hook($hookfile) { global $conf; $s = ''; $plugins = core::get_plugins($conf['plugin_path']); $paths = array_keys($plugins); $df = opendir($conf['plugin_path']); foreach($paths as $path) { if(!is_file($path.$hookfile)) continue; $s2 = file_get_contents($path.$hookfile); $s2 = preg_replace('#^<\?php\s*exit;\?>\s{0,2}#i', '', $s2); $s .= $s2; } return $s; } public static function run() { global $conf; $control = core::gpc(0); $action = core::gpc(1); $objfile = $conf['tmp_path'].$conf['app_id']."_{$control}_control.class.php"; if(!is_file($objfile) || DEBUG) { $controlfile = ''; $paths = $conf['control_path']; foreach($paths as $path) { $controlfile = $path."{$control}_control.class.php"; if(is_file($controlfile)) break; } if(empty($controlfile)) { $plugins = core::get_plugins($conf['plugin_path']); $paths = array_keys($plugins); foreach($paths as $path) { $controlfile = $path."{$control}_control.class.php"; if(is_file($controlfile)) break; } } if(empty($controlfile)) { throw new Exception("{$control}_control.class.php 不存在。"); } $s = file_get_contents($controlfile); $s = preg_replace('#\t*\/\/\s*hook\s+([^\s]+)#ies', "core::process_hook('\\1')", $s); if($conf['urlrewrite']) { $s = preg_replace('#([\'"])\?(.+?\.htm)#i', '\\1'.$conf['app_url'].'\\2', $s); } else { $s = preg_replace('#([\'"])\?(.+?\.htm)#i', '\\1'.$conf['app_url'].'?\\2', $s); } file_put_contents($objfile, $s); } if(@include $objfile) { $controlclass = "{$control}_control"; $onaction = "on_$action"; $newcontrol = new $controlclass(); if(method_exists($newcontrol, $onaction)) { $newcontrol->$onaction(); } else { throw new Exception('方法未实现:'.$action); } } else { throw new Exception("control $newcontrol does not exists."); } unset($newcontrol, $control, $action); } public static function get_url_path() { $port = self::gpc('SERVER_PORT', 'S'); $portadd = $port == 80 ? '' : ':80'; $host = self::gpc('HTTP_HOST', 'S'); $path = substr(self::gpc('PHP_SELF', 'S'), 0, strrpos(self::gpc('PHP_SELF', 'S'), '/')); return "http://$host$portadd$path/"; } public static function get_plugins($path) { static $plugins = array(); if(!empty($plugins)) return $plugins; $arr = self::get_paths($path); foreach($arr as $k=>$v) { $conffile = $v.'conf.php'; $pconf = is_file($conffile) ? include($conffile) : array(); if(!empty($pconf['enable'])) { $plugins[$v] = $pconf; } } return $plugins; } public static function get_paths($path, $fullpath = TRUE) { $arr = array(); $df = opendir($path); while($dir = readdir($df)) { if($dir == '.' || $dir == '..' || $dir[0] == '.' || !is_dir($path.$dir)) continue; $arr[] = $fullpath ? $path.$dir.'/' : $dir; } sort($arr); return $arr; } public static function get_model($model, $conf) { $paths = (array)$conf['model_path']; $new = core::get_model_real($model, $paths); if(!$new) { $plugins = core::get_plugins($conf['plugin_path']); $paths = array_keys($plugins); $new = core::get_model_real($model, $paths); } return $new; } public static function get_model_real($model, $paths) { foreach($paths as &$path) { if(isset($_SERVER['models'][$model])) { return $_SERVER['models'][$model]; } else { if(is_file($path."$model.class.php")) { include_once $path."$model.class.php"; $new = new $model(); $_SERVER['models'][$model] = $new; return $new; } else { continue; } } } return FALSE; } public static function json_encode($data) { if(version_compare(PHP_VERSION, '5.2.0', '>=')) { return json_encode($data); } if(is_array($data) || is_object($data)) { $islist = is_array($data) && (empty($data) || array_keys($data) === range(0,count($data)-1)); if($islist) { $json = '['.implode(',', array_map(array('core', 'json_encode'), $data)).']'; } else { $items = Array(); foreach($data as $key => $value) $items[] = self::json_encode("$key").':'.self::json_encode($value); $json = '{'.implode(',', $items).'}'; } } elseif(is_string($data)) { $string = '"'.addcslashes($data, "\\\"\n\r\t/".chr(8).chr(12)).'"'; $json = ''; $len = strlen($string); for($i = 0; $i < $len; $i++ ) { $char = $string[$i]; $c1 = ord($char); if($c1 <128 ) { $json .= ($c1 > 31) ? $char : sprintf("\\u%04x", $c1); continue; } $c2 = ord($string[++$i]); if (($c1 & 32) === 0) { $json .= sprintf("\\u%04x", ($c1 - 192) * 64 + $c2 - 128); continue; } $c3 = ord($string[++$i]); if(($c1 & 16) === 0) { $json .= sprintf("\\u%04x", (($c1 - 224) <<12) + (($c2 - 128) << 6) + ($c3 - 128)); continue; } $c4 = ord($string[++$i]); if(($c1 & 8 ) === 0) { $u = (($c1 & 15) << 2) + (($c2>>4) & 3) - 1; $w1 = (54<<10) + ($u<<6) + (($c2 & 15) << 2) + (($c3>>4) & 3); $w2 = (55<<10) + (($c3 & 15)<<6) + ($c4-128); $json .= sprintf("\\u%04x\\u%04x", $w1, $w2); } } } else { $json = strtolower(var_export( $data, true )); } return $json; } } ?><?php
 class misc { public static function page($key = 'page') { return max(1, intval(core::gpc($key, 'R'))); } public static function pages($url, $totalnum, $page, $pagesize = 20) { $urladd = ''; if(strpos($url, '.htm') !== FALSE) { list($url, $urladd) = explode('.htm', $url); $urladd = '.htm'.$urladd; $rewritepage = '-page-'; } else { $url .= strpos($url, '?') === FALSE ? '?' : '&'; $rewritepage = 'page='; } $totalpage = ceil($totalnum / $pagesize); if($totalpage < 2) return ''; $page = min($totalpage, $page); $shownum = 5; $start = max(1, $page - $shownum); $end = min($totalpage, $page + $shownum); $right = $page + $shownum - $totalpage; $right > 0 && $start = max(1, $start -= $right); $left = $page - $shownum; $left < 0 && $end = min($totalpage, $end -= $left); $s = ''; $page != 1 && $s .= '<a href="'.$url.$rewritepage.($page - 1).$urladd.'">上一页</a>'; if($start > 1) $s .= '<a href="'.$url.$rewritepage.'1'.$urladd.'">1 '.($start > 2 ? '... ' : '').'</a>'; for($i=$start; $i<=$end; $i++) { if($i == $page) { $s .= '<b>'.$i.'</b>'; } else { $s .= '<a href="'.$url.$rewritepage.$i.$urladd.'">'.$i.'</a>'; } } if($end != $totalpage) $s .= '<a href="'.$url.$rewritepage.$totalpage.$urladd.'">'.($totalpage - $end > 1 ? '... ' : '').$totalpage.'</a>'; $page != $totalpage && $s .= '<a href="'.$url.$rewritepage.($page + 1).$urladd.'">下一页</a>'; return $s; } public static function simple_page($url, $totalnum, $page, $pagesize) { $urladd = ''; if(strpos($url, '.htm') !== FALSE) { list($url, $urladd) = explode('.htm', $url); $urladd = '.htm'.$urladd; $rewritepage = '-page-'; } else { $url .= strpos($url, '?') === FALSE ? '?' : '&'; $rewritepage = 'page='; } $s = ''; $page > 1 && $s .= '<a href="'.$url.$rewritepage.($page - 1).$urladd.'">上一页</a>'; $totalnum >= $pagesize && $s .= '<a href="'.$url.$rewritepage.($page + 1).$urladd.'">下一页</a>'; return $s; } public static function set_cookie($key, $value, $time = 0, $path = '', $httponly = FALSE) { if($value != NULL) { if(version_compare(PHP_VERSION, '5.2.0') >= 0) { setcookie($key, $value, $time, $path, '', FALSE, $httponly); } else { setcookie($key, $value, $time, $path, '', FALSE); } } else { if(version_compare(PHP_VERSION, '5.2.0') >= 0) { setcookie($key, '', $time, $path, '', FALSE, $httponly); } else { setcookie($key, '', $time, $path, '', FALSE); } } } public static function form_hash($public_key) { return substr(md5(substr($_SERVER['time'], 0, -5).$public_key), 16); } public static function form_submit($public_key) { $hash = core::gpc('FORM_HASH', 'R'); return $hash == self::form_hash($public_key); } public static function get_url_path() { $port = core::gpc('SERVER_PORT', 'S'); $host = core::gpc('HTTP_HOST', 'S'); $path = substr(core::gpc('PHP_SELF', 'S'), 0, strrpos(core::gpc('PHP_SELF', 'S'), '/')); return "http://$host$path/"; } public static function get_script_uri() { $port = core::gpc('SERVER_PORT', 'S'); $host = core::gpc('HTTP_HOST', 'S'); if(isset($_SERVER['HTTP_X_REWRITE_URL'])) { $request_uri = $_SERVER['HTTP_X_REWRITE_URL']; } else { $request_uri = $_SERVER['REQUEST_URI']; } return "http://$host".$request_uri; } public static function date($time, $format = 'Y-n-j H:i', $timeoffset = '+8') { return gmdate($format, $time + $timeoffset * 3600); } public static function minidate($time, $timeoffset = 8) { $sub = $_SERVER['time_today'] - $time; if($sub < 0) { $format = 'H:i'; } elseif($sub > 31536000) { $format = 'Y-n'; } elseif($sub > 86400) { $format = 'n-j'; } else { $format = 'n-j'; } return gmdate($format, $time + $timeoffset * 3600); } public static function humandate($timestamp) { $seconds = $_SERVER['time'] - $timestamp; if($seconds > 31536000) { return self::date($timestamp, 'Y-n-j'); } elseif($seconds > 2592000) { return ceil($seconds / 2592000).'月前'; } elseif($seconds > 86400) { return ceil($seconds / 86400).'天前'; } elseif($seconds > 3600) { return ceil($seconds / 3600).'小时前'; } elseif($seconds > 60) { return ceil($seconds / 60).'分钟前'; } else { return $seconds.'秒前'; } } public static function humannumber($num) { $num > 100000 && $num = ceil($num / 10000).'万'; return $num; } public static function humansize($num) { if($num > 1000000) { return number_format($num / 1000000, 2, '.', '').'M'; } elseif($num > 1000) { return number_format($num / 1000, 2, '.', '').'K'; } else { return $num.'B'; } } public static function values_empty($arr) { return implode('', $arr) == '' ? TRUE : FALSE; } public static function array_to_urladd($arr) { $s = ''; foreach((array)$arr as $k=>$v) { $s .= "-$k-".urlencode($v); } return $s; } public static function arrlist_key_values(&$arrlist, $key, $value) { $return = array(); if($key) { foreach($arrlist as $arr) { $return[$arr[$key]] = $arr[$value]; } } else { foreach($arrlist as $arr) { $return[] = $arr[$value]; } } return $return; } public static function arrlist_values(&$arrlist, $key) { $return = array(); foreach($arrlist as &$arr) { $return[] = $arr[$key]; } return $return; } public static function arrlist_multisort(&$arrlist, $col, $asc = TRUE) { $colarr = array(); foreach($arrlist as $k=>$arr) { $colarr[$k] = $arr[$col]; } $asc = $asc ? SORT_ASC : SORT_DESC; array_multisort($colarr, $asc, $arrlist); } public static function key_str_merge($haystack, $needle) { $haystack .= ' '.$needle; $arr = explode(' ', $haystack); $arr = array_unique($arr); return trim(implode(' ', $arr)); } public static function key_str_strip($haystack, $needle) { $haystack = " {$haystack} "; $arr = explode(' ', trim($needle)); foreach($arr as $v) { $haystack = str_replace(' '.$v.' ', ' ', $haystack); } return trim($haystack); } public static function in_key_str($needle, $haystack) { return strpos(" {$needle} ", " {$haystack} ") !== FALSE; } public static function safe_str(&$s, $ext = '') { $ext = preg_quote($ext); $s = preg_replace('#[^'.$ext.'\w\x{4e00}-\x{9fa5}]+#u', '', $s); } public static function html_space($s, $onlytab = FALSE) { if($onlytab) { $s = str_replace("\t", '&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ', $s); return $s; } else { $s = str_replace(' ', '&nbsp;', $s); $s = str_replace("\t", '&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ', $s); $s = nl2br($s); return $s; } } public static function get_url($url, $timeout = 5) { if(ini_get('allow_url_fopen')) { $opts = array ('http'=>array('method'=>'GET', 'timeout'=>$timeout)); $context = stream_context_create($opts); $html = file_get_contents($url, false, $context); return $html; } else { $limit = 500000; $ip = ''; $return = ''; $matches = parse_url($url); $host = $matches['host']; $path = $matches['path'] ? $matches['path'].($matches['query'] ? '?'.$matches['query'] : '') : '/'; $port = !empty($matches['port']) ? $matches['port'] : 80; $out = "GET $path HTTP/1.0\r\n"; $out .= "Accept: */*\r\n"; $out .= "Accept-Language: zh-cn\r\n"; $out .= "User-Agent: $_SERVER[HTTP_USER_AGENT]\r\n"; $out .= "Host: $host\r\n"; $out .= "Connection: Close\r\n"; $out .= "Cookie:\r\n\r\n"; $host == 'localhost' && $ip = '127.0.0.1'; $fp = @fsockopen(($ip ? $ip : $host), $port, $errno, $errstr, $timeout); if(!$fp) { return ''; } else { stream_set_blocking($fp, TRUE); stream_set_timeout($fp, $timeout); @fwrite($fp, $out); $status = stream_get_meta_data($fp); if(!$status['timed_out']) { while (!feof($fp)) { if(($header = @fgets($fp)) && ($header == "\r\n" || $header == "\n")) { break; } } $stop = false; while(!feof($fp) && !$stop) { $data = fread($fp, ($limit == 0 || $limit > 8192 ? 8192 : $limit)); $return .= $data; if($limit) { $limit -= strlen($data); $stop = $limit <= 0; } } } @fclose($fp); return $return; } } } } ?><?php
 if(!isset($_SERVER['time'])) { $_SERVER['time'] = time(); } if(!isset($_SERVER['time_fmt'])) { $_SERVER['time_fmt'] = gmdate('y-n-j H:i', $_SERVER['time'] + 86400 * 8); } class log { public static function write($s, $file = 'phperror.php') { $logpath = FRAMEWORK_LOG_PATH; $s = self::safe_str($s); $logfile = $logpath.$file; $ip = $_SERVER['ip']; $time = $_SERVER['time_fmt']; $url = $_SERVER['REQUEST_URI']; $url = self::safe_str($url); if(!error_log('<?php exit;?>'."	$time	$ip	$url	$s	\r\n", 3, $logfile)) { throw new Exception('写入日志失败，可能磁盘已满，或者文件'.$logfile.'不可写。'); } } public static function safe_str($s) { $s = str_replace("\r\n", ' ', $s); $s = str_replace("\r", ' ', $s); $s = str_replace("\n", ' ', $s); $s = str_replace("\t", ' ', $s); return $s; } } ?><?php
 if(empty($_SERVER['ip'])) { $_SERVER['ip'] = core::gpc('REMOTE_ADDR', 'S'); } if(empty($_SERVER['time'])) { $_SERVER['time'] = time(); } class xn_exception { public static function format_exception($e) { $trace = $e->getTrace(); if(!empty($trace) && $trace[0]['function'] == 'error_handle' && $trace[0]['class'] == 'core') { $line = $trace[0]['args'][3]; $file = $trace[0]['args'][2]; $message = $trace[0]['args'][1]; } else { $line = $e->getLine(); $file = $e->getFile(); $message = $e->getMessage(); } $backtracelist = array(); foreach($trace as $k=>$v) { $args = $comma = ''; if(!empty($v['args'])) { if(DEBUG > 1) { foreach((array)$v['args'] as $arg) { if(is_string($arg)) { $args .= $comma."'$arg'"; } elseif(is_object($arg)) { $args .= $comma."Object"; } elseif(is_array($arg)) { if(!isset($arg['db'])) { $arg = htmlspecialchars(print_r($arg, 1)); } else { $arg = '$conf = array()'; } $arg = str_replace(array("\t", ' '), array('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;', '&nbsp;'), $arg); $arg = nl2br($arg); $args .= $comma.$arg; } else { $args .= $comma.$arg; } $comma = ', '; } } else { $args = ''; } } !isset($v['file']) && $v['file'] = ''; !isset($v['line']) && $v['line'] = ''; !isset($v['function']) && $v['function'] = ''; $backtracelist[] = array ( 'file'=>$v['file'], 'line'=>$v['line'], 'function'=>$v['function'], 'args'=>$args, ); } $codelist = self::get_code($file, $line); return array( 'line'=>$line, 'file'=>$file, 'codelist'=>$codelist, 'message'=>$message, 'backtracelist'=>$backtracelist, ); } public static function get_code($file, $line) { $arr = file($file); $arr2 = array_slice($arr, max(0, $line - 5), 10, true); if(!core::is_cmd()) { foreach ($arr2 as &$v) { $v = htmlspecialchars($v); $v = str_replace(' ', '&nbsp;', $v); $v = str_replace('	', '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;', $v); } } return $arr2; } public static function to_text($e) { return self::to_string(); } public static function to_html($e) { return self::to_string($e); } public static function to_string($e) { if(is_object($e)) { $arr = self::format_exception($e); $line = $arr['line']; $file = $arr['file']; $codelist = $arr['codelist']; $message = $arr['message']; $backtracelist = $arr['backtracelist']; ob_end_clean(); core::ob_start(); if(core::is_cmd()) { include FRAMEWORK_PATH.'errorpage/exception_cmd.htm'; } else { include FRAMEWORK_PATH.'errorpage/exception.htm'; } $s = ob_get_contents(); ob_end_clean(); core::ob_start(); return $s; } elseif(is_string($e)) { return $e; } } public static function to_json($e) { $s = $e->getMessage(); $s = preg_replace('# \S*[/\\\\](.+?\.php)#', ' \\1', $s); $arr = array('servererror' => $s); return core::json_encode($arr); } } ?><?php
 class base_control { public $conf = array(); function __construct() { global $conf; $this->conf = &$conf; } public function __get($var) { if($var == 'view') { $this->view = new template($this->conf); return $this->view; } else { $this->$var = core::get_model($var, $this->conf); if(!$this->$var) { throw new Exception('未找到 model:'.$var); } return $this->$var; } } public function message($msg, $jumpurl = '') { if(core::gpc('ajax')) { ob_end_clean(); $arr = array('servererror'=>'', 'status'=>1, 'message'=>$msg); echo core::json_encode($arr); } else { include FRAMEWORK_PATH.'errorpage/message.htm'; exit; } } public function __call($method, $args) { throw new Exception('base_control.class.php: 未实现该方法：'.$method.': ('.var_export($args, 1).')'); } } ?><?php
 class base_model { public $conf = array(); public $table; public $primarykey = array(); public $maxcol = ''; static $dbinsts = array(); static $cacheinsts = array(); private $unique; function __construct() { global $conf; $this->conf = &$conf; } function __get($var) { if($var == 'db') { $this->$var = $this->get_db_instance(); return $this->$var; } elseif($var == 'cache') { $this->$var = $this->get_cache_instance(); return $this->$var; } else { $this->$var = core::get_model($var, $this->conf); if(!$this->$var) { throw new Exception('未找到 model:'.$var); } return $this->$var; } } function __call($method, $parms) { throw new Exception("$method does not exists."); } public function get_db_conf($key = '') { return $this->conf['db']; } public function get_db_instance($key = '') { $conf = $this->get_db_conf($key); $c = $conf[$conf['type']]; !isset($c['master']['tablepre']) && $c['master']['tablepre'] = ''; !isset($c['master']['name']) && $c['master']['name'] = ''; $conf['id'] = $c['master']['host'].'-'.$c['master']['user'].'-'.$c['master']['password'].'-'.$c['master']['name'].'-'.$c['master']['tablepre']; if(isset(self::$dbinsts[$conf['id']])) { return self::$dbinsts[$conf['id']]; } else { $type = $conf['type']; $dbname = 'db_'.$type; self::$dbinsts[$conf['id']] = new $dbname($conf[$type]); return self::$dbinsts[$conf['id']]; } } public function db_set($key, $data) { return $this->get_db_instance($key)->set($key, $data); } public function db_get($key) { return $this->get_db_instance($key)->get($key); } public function db_delete($key) { return $this->get_db_instance($key)->delete($key); } public function get_cache_conf($key = '') { return $this->conf['cache']; } public function get_cache_instance($key = '') { $conf = $this->get_cache_conf($key); $c = $conf[$conf['type']]; $conf['id'] = $c['host'].'-'.$c['port']; if(isset(self::$cacheinsts[$conf['id']])) { return self::$cacheinsts[$conf['id']]; } else { $type = $conf['type']; $cachename = 'cache_'.$type; self::$cacheinsts[$conf['id']] = new $cachename($conf[$type]); return self::$cacheinsts[$conf['id']]; } } public function cache_set($key, $data) { return $this->get_cache_instance($key)->set($key, $data); } public function cache_get($key) { return $this->get_cache_instance($key)->get($key); } public function cache_delete($key) { return $this->get_cache_instance($key)->delete($key); } public function db_cache_set($key, $data, $life = 0) { $this->conf['cache']['enable'] && $this->cache_set($key, $data, $life); return $this->db_set($key, $data); } public function db_cache_get($key) { if($this->conf['cache']['enable']) { $arr = $this->cache_get($key); if(!$arr) { $arrlist = $this->db_get($key); if(is_array($key)) { foreach((array)$arrlist as $k=>$v) { $this->cache_set($k, $v); } } else { $this->cache_set($key, $arrlist); } return $arrlist; } else { return $arr; } } else { return $this->db_get($key); } } public function db_cache_delete($key) { $this->conf['cache']['enable'] && $this->cache_delete($key); return $this->db_delete($key); } public function db_cache_maxid($val = FALSE) { $key = $this->table.'-'.$this->maxcol; if($this->conf['cache']['enable']) { $this->cache->maxid($key, $val); return $this->db->maxid($key, $val); } else { return $this->db->maxid($key, $val); } } public function db_cache_count($val = FALSE) { $key = $this->table; if($this->conf['cache']['enable']) { $this->cache->count($key, $val); return $this->db->count($key, $val); } else { return $this->db->count($key, $val); } } public function db_cache_index_fetch($table, $keyname, $cond = array(), $orderby = array(), $start = 0, $limit = 10) { if($this->conf['db']['type'] == 'mongodb') { return $this->db->index_fetch($table, $keyname, $cond, $orderby, $start, $limit); } else { if($this->conf['cache']['enable']) { $keynames = $this->db->index_fetch_id($table, $keyname, $cond, $orderby, $start, $limit); return $this->db_cache_get($keynames); } else { return $this->db->index_fetch($table, $keyname, $cond, $orderby, $start, $limit); } } } public function get($id1, $id2 = FALSE, $id3 = FALSE) { $keys= $this->get_key($id1, $id2, $id3); if(is_array($keys)) { $arrlist = array(); foreach($keys as $k=>$key) { if(isset($this->unique[$key])) { $arrlist[$key] = $this->unique[$key]; unset($keys[$k]); } else { $arrlist[$key] = NULL; $this->unique[$key] = $arrlist[$key]; } } $arrlist2 = $this->db_cache_get($keys); $arrlist = array_merge($arrlist, $arrlist2); return $arrlist; } else { if(!isset($this->unique[$keys])) { $this->unique[$keys] = $this->db_cache_get($keys); } return $this->unique[$keys]; } } public function set($id1, $id2 = FALSE, $id3 = FALSE, $id4 = FALSE) { $arr = array(); if($id4 !== FALSE) { $arr = $id4; $key = $this->get_key($id1, $id2, $id3); } elseif($id3 !== FALSE) { $arr = $id3; $key = $this->get_key($id1, $id2); } elseif($id2 !== FALSE) { $arr = $id2; $key = $this->get_key($id1); } else { return FALSE; } $this->unique[$key] = $arr; return $this->db_cache_set($key, $arr); } public function delete($id1, $id2 = FALSE, $id3 = FALSE) { $key = $this->get_key($id1, $id2, $id3); unset($this->unique[$key]); return $this->db_cache_delete($key); } public function maxid($val = FALSE) { return $this->db_cache_maxid($val); } public function count($val = FALSE) { $key = $this->table; return $this->db_cache_count($val); } public function native_count() { return $this->db->native_count($this->table); } public function native_maxid() { return $this->db->native_maxid($this->table, $this->maxcol); } public function index_fetch($cond = array(), $orderby = array(), $start = 0, $limit = 10) { return $this->db_cache_index_fetch($this->table, $this->primarykey, $cond, $orderby, $start, $limit); } public function index_fetch_id($cond = array(), $orderby = array(), $start = 0, $limit = 10) { return $this->db->index_fetch_id($this->table, $this->primarykey, $cond, $orderby, $start, $limit); } private function get_key($id1, $id2 = FALSE, $id3 = FALSE) { if(is_array($id1)) { $keys = array(); foreach($id1 as $k=>$v) { $keys[$k] = $this->get_key_real($id1[$k], ($id2 === FALSE ? FALSE : $id2[$k]), ($id3 === FALSE ? FALSE : $id3[$k])); } return $keys; } else { return $this->get_key_real($id1, $id2, $id3); } } private function get_key_real($id1, $id2 = FALSE, $id3 = FALSE) { if(strpos($id1, '-') !== FALSE) { return $id1; } else { $s = $this->table.'-'.$this->primarykey[0]."-$id1"; $id2 !== FALSE && $s .= "-".$this->primarykey[1]."-$id2"; $id3 !== FALSE && $s .= "-".$this->primarykey[2]."-$id3"; return $s; } } } ?><?php
 function long2str($v, $w) { $len = count($v); $n = ($len - 1) << 2; if ($w) { $m = $v[$len - 1]; if (($m < $n - 3) || ($m > $n)) return false; $n = $m; } $s = array(); for ($i = 0; $i < $len; $i++) { $s[$i] = pack("V", $v[$i]); } if ($w) { return substr(join('', $s), 0, $n); } else { return join('', $s); } } function str2long($s, $w) { $v = unpack("V*", $s. str_repeat("\0", (4 - strlen($s) % 4) & 3)); $v = array_values($v); if ($w) { $v[count($v)] = strlen($s); } return $v; } function int32($n) { while ($n >= 2147483648) $n -= 4294967296; while ($n <= -2147483649) $n += 4294967296; return (int)$n; } function xxtea_encrypt($str, $key) { if ($str == "") { return ""; } $v = str2long($str, true); $k = str2long($key, false); if (count($k) < 4) { for ($i = count($k); $i < 4; $i++) { $k[$i] = 0; } } $n = count($v) - 1; $z = $v[$n]; $y = $v[0]; $delta = 0x9E3779B9; $q = floor(6 + 52 / ($n + 1)); $sum = 0; while (0 < $q--) { $sum = int32($sum + $delta); $e = $sum >> 2 & 3; for ($p = 0; $p < $n; $p++) { $y = $v[$p + 1]; $mx = int32((($z >> 5 & 0x07ffffff) ^ $y << 2) + (($y >> 3 & 0x1fffffff) ^ $z << 4)) ^ int32(($sum ^ $y) + ($k[$p & 3 ^ $e] ^ $z)); $z = $v[$p] = int32($v[$p] + $mx); } $y = $v[0]; $mx = int32((($z >> 5 & 0x07ffffff) ^ $y << 2) + (($y >> 3 & 0x1fffffff) ^ $z << 4)) ^ int32(($sum ^ $y) + ($k[$p & 3 ^ $e] ^ $z)); $z = $v[$n] = int32($v[$n] + $mx); } return long2str($v, false); } function xxtea_decrypt($str, $key) { if ($str == "") { return ""; } $v = str2long($str, false); $k = str2long($key, false); if (count($k) < 4) { for ($i = count($k); $i < 4; $i++) { $k[$i] = 0; } } $n = count($v) - 1; $z = $v[$n]; $y = $v[0]; $delta = 0x9E3779B9; $q = floor(6 + 52 / ($n + 1)); $sum = int32($q * $delta); while ($sum != 0) { $e = $sum >> 2 & 3; for ($p = $n; $p > 0; $p--) { $z = $v[$p - 1]; $mx = int32((($z >> 5 & 0x07ffffff) ^ $y << 2) + (($y >> 3 & 0x1fffffff) ^ $z << 4)) ^ int32(($sum ^ $y) + ($k[$p & 3 ^ $e] ^ $z)); $y = $v[$p] = int32($v[$p] - $mx); } $z = $v[$n]; $mx = int32((($z >> 5 & 0x07ffffff) ^ $y << 2) + (($y >> 3 & 0x1fffffff) ^ $z << 4)) ^ int32(($sum ^ $y) + ($k[$p & 3 ^ $e] ^ $z)); $y = $v[0] = int32($v[0] - $mx); $sum = int32($sum - $delta); } return long2str($v, true); } function encrypt($txt, $key = 'abcd9667676effff') { return urlencode(base64_encode(xxtea_encrypt($txt, $key))); } function decrypt($txt, $key = 'abcd9667676effff') { return xxtea_decrypt(base64_decode(urldecode($txt)), $key); } ?><?php
 class template { private $vars; private $force = 1; private $var_regexp = "\@?\\\$[a-zA-Z_]\w*(?:\[[\w\.\"\'\[\]\$]+\])*"; private $vtag_regexp = "\<\?=(\@?\\\$[a-zA-Z_]\w*(?:\[[\w\.\"\'\[\]\$]+\])*)\?\>"; private $const_regexp = "\{([\w]+)\}"; public $conf = array(); public $json = array(); function __construct(&$conf) { $this->conf = &$conf; } public function assign($k, &$v) { $this->vars[$k] = &$v; } public function assign_value($k, $v) { $this->vars[$k] = $v; } public function display($file, $json = array()) { if(!core::gpc('ajax', 'R')) { extract($this->vars, EXTR_SKIP); include $this->gettpl($file); } else { extract($this->vars, EXTR_SKIP); include $this->gettpl($file); $body = ob_get_contents(); ob_end_clean(); core::ob_start(); $json = array('servererror'=>'', 'status'=>1, 'message'=>array('width'=>400, 'height'=>300, 'pos'=>'center', 'title'=>'默认窗口标题', 'body'=>'')); $json['message'] = array_merge($json['message'], $this->json); $this->fetch_json_header($body, $json['message']); $json['message']['body'] = $body; echo core::json_encode($json); } } public function gettpl($filename) { $objfile = $this->conf['tmp_path'].$this->conf['app_id'].'_'.$filename.'.php'; if(!$this->force) return $objfile; if(!is_file($objfile) || DEBUG > 0) { $file = ''; foreach($this->conf['view_path'] as $path) { $file = $path.$filename; if(is_file($file)) break; } if(empty($file)) { $plugins = core::get_plugins($this->conf['plugin_path']); $paths = array_keys($plugins); foreach($paths as $path) { $file = $path.$filename; if(is_file($file)) break; } } if(empty($file)) { throw new Exception("模板文件 $filename 不存在。"); } $filemtime = filemtime($file); if(!$filemtime) { throw new Exception("模板文件 $filename 最后更新时间读取失败。"); } $filemtimeold = is_file($objfile) ? filemtime($objfile) : 0; if($filemtimeold < $filemtime || DEBUG > 1) { $this->complie($file, $objfile); } } return $objfile; } public function complie($viewfile, $objfile) { $s = file_get_contents($viewfile); $s = $this->convert_button($s); $s = preg_replace("/<!--\{(.+?)\}-->/s", "{\\1}", $s); for($i = 0; $i < 4; $i++) { $s = preg_replace("/<!--\{(.+?)\}-->/s", "{\\1}", $s); $s = preg_replace('#\{hook\s+([^}]+)\}#ies', "\$this->process_hook('\\1')", $s); $s = preg_replace('#\t*//\s*hook\s+([^\s]+)#ies', "\$this->process_hook('\\1')", $s); } $s = preg_replace("/<!--\{(.+?)\}-->/s", "{\\1}", $s); $s = preg_replace("/($this->var_regexp|\{$this->var_regexp\})/", "<?=\\1?>", $s); $s = preg_replace("/\<\?=\{(.+?)\}\?\>/", "<?=\\1?>", $s); $s = preg_replace("/\{($this->const_regexp)\}/", "<?=\\1?>", $s); $s = preg_replace("/\<\?=(\@?\\\$[a-zA-Z_]\w*)((\[[^\]]+\])+)\?\>/ies", "\$this->arrayindex('\\1', '\\2')", $s); $s = preg_replace('#([\'"])(view\w*)/#i', '\\1'.$this->conf['static_url'].'\\2/', $s); $s = preg_replace('#([\'"])(plugin/view\w*)/#i', '\\1'.$this->conf['static_url'].'\\2/', $s); $s = preg_replace('#\{include\s+([^}]*?)\}#is', "<?php include \$this->gettpl('\\1');?>", $s); $isset = '<\?php echo isset(?:+*?) ? (?:+*?) : ;\?>'; $s = preg_replace("/\{\{php (.*?)\}\}/ies", "\$this->stripvtag('<? \\1?>')", $s); $s = preg_replace("/\{php (.*?)\}/ies", "\$this->stripvtag('<? \\1?>')", $s); $s = preg_replace("/\{for (.*?)\}/ies", "\$this->stripvtag('<? for(\\1) {?>')", $s); $s = preg_replace("/\{elseif\s+(.+?)\}/ies", "\$this->stripvtag('<? } elseif(\\1) { ?>')", $s); for($i=0; $i<4; $i++) { $s = preg_replace("/\{loop\s+$this->vtag_regexp\s+$this->vtag_regexp\s+$this->vtag_regexp\}(.+?)\{\/loop\}/ies", "\$this->loopsection('\\1', '\\2', '\\3', '\\4')", $s); $s = preg_replace("/\{loop\s+$this->vtag_regexp\s+$this->vtag_regexp\}(.+?)\{\/loop\}/ies", "\$this->loopsection('\\1', '', '\\2', '\\3')", $s); } $s = preg_replace("/\{if\s+(.+?)\}/ies", "\$this->stripvtag('<? if(\\1) { ?>')", $s); $s = preg_replace("/\{else\}/is", "<? } else { ?>", $s); $s = preg_replace("/\{\/if\}/is", "<? } ?>", $s); $s = preg_replace("/\{\/for\}/is", "<? } ?>", $s); $s = preg_replace("/$this->const_regexp/", "<?=\\1?>", $s); $s = preg_replace("/\<\?=\@(\\\$[a-zA-Z_]\w*)((\[[\\$\[\]\w\']+\])+)\?\>/ies", "\$this->array_keyexists('\\1', '\\2')", $s); $s = "<? if(!defined('FRAMEWORK_PATH')) exit('Access Denied');?>$s"; $s = preg_replace('#<\?=(\w+.*?)\?>#', "<?php echo \\1;?>", $s); $s = preg_replace('#<\?=(\$\w+.*?)\?>#', "<?php echo isset(\\1) ? \\1 : '';?>", $s); $s = preg_replace('#<\? (.*?)\?>#', "<?php \\1?>", $s); $s = preg_replace('#\{json (.*?)\}#', '<!--{json \\1}-->', $s); if($this->conf['urlrewrite']) { $s = preg_replace('#([\'"])\?(.+?\.htm)#i', '\\1'.$this->conf['app_url'].'\\2', $s); } else { $s = preg_replace('#([\'"])\?(.+?\.htm)#i', '\\1'.$this->conf['app_url'].'?\\2', $s); } if(!($fp = fopen($objfile, 'wb'))) { return FALSE; } function_exists('flock') && flock($fp, LOCK_EX); fwrite($fp, $s, strlen($s)); fclose($fp); } private function process_hook($hookfile) { $s = core::process_hook($hookfile); return $s; } private function arrayindex($name, $items) { if(strpos($items, '$') === FALSE) { $items = preg_replace("/\[([\$a-zA-Z_][\w\$]*)\]/is", "['\\1']", $items); } else { $items = preg_replace("/\[([\$a-zA-Z_][\w\$]*)\]/is", "[\"\\1\"]", $items); } return "<?=$name$items?>"; } private function array_keyexists($name, $items) { return "<?php echo isset($name$items) ? $name$items : '';?>"; } private function stripvtag($s, $instring = FALSE) { $s = preg_replace('#<\?php echo isset\((.*?)\) \? (\\1) : \'\';\?>#', $instring ? '{\\1}' : '\\1', $s); return preg_replace("/$this->vtag_regexp/is", "\\1", str_replace("\\\"", '"', $s)); } private function fetch_json_header(&$s, &$arr) { preg_match('#<!--\{json (.*?)\}-->#', $s, $m); if(isset($m[1])) { preg_match_all('#(\w+):"(.*?)"#', $m[1], $m2); foreach($m2[1] as $k=>$v) { $arr[$m2[1][$k]] = $m2[2][$k]; } $s = preg_replace('#<!--\{json (.*?)\}-->#', '', $s); } return $arr; } private function loopsection($arr, $k, $v, $statement) { $arr = $this->stripvtag($arr); $k = $this->stripvtag($k); $v = $this->stripvtag($v); $statement = str_replace("\\\"", '"', $statement); return $k ? "<? if(!empty($arr)) { foreach($arr as $k=>&$v) {?>$statement<? }}?>" : "<? if(!empty($arr)) { foreach($arr as &$v) {?>$statement<? }} ?>"; } private function convert_button($s) { $r = ''; $p = '#<input ([^<]*?)>#is'; $offset = 0; while(preg_match($p, $s, $m, PREG_OFFSET_CAPTURE)) { $start = $m[0][1]; $len = strlen($m[0][0]); preg_match_all('#(\w+)\s*=\s*"(.*?)"#', $m[1][0], $m2); if(!empty($m2[1]) && !empty($m2[2])) { $arr = array_combine($m2[1], $m2[2]); } else { $arr = array(); } $offset = $len + $start; if(!isset($arr['class']) || strpos($arr['class'], 'button') === FALSE) { $r .= substr($s, 0, $offset); $s = substr($s, $offset); continue; } $value = $arr['value']; $attrs = ''; !isset($arr['href']) && $arr['href'] = 'javascript:void(0)'; foreach($arr as $k=>$v) { $k == 'onclick' && stripos($v, 'return false') === FALSE && $v .= ";return false;"; $attrs .= " $k=\"$v\""; } $r .= substr($s, 0, $start)."<a$attrs><span>$value</span></a>"; $s = substr($s, $offset); } $r .= $s; return $r; } } ?><?php
 if(!defined('FRAMEWORK_PATH')) { exit('FRAMEWORK_PATH not defined.'); } interface db_interface { public function __construct($conf); public function set($key, $data, $life = 0); public function get($key); public function delete($key); public function maxid($table, $val = 0); public function count($table, $val = 0); public function native_maxid($table, $col); public function native_count($table); public function truncate($table); public function version(); public function index_fetch($table, $keyname, $cond = array(), $orderby = array(), $start = 0, $limit = 0); public function index_fetch_id($table, $keyname, $cond = array(), $orderby = array(), $start = 0, $limit = 0); public function index_create($table, $index); public function index_drop($table, $index); } ?><?php
 if(!defined('FRAMEWORK_PATH')) { exit('FRAMEWORK_PATH not defined.'); } interface cache_interface { public function __construct($conf); public function set($key, $data, $life = 0); public function get($key); public function delete($key); public function maxid($table, $val = 0); public function count($table, $val = 0); } ?><?php
 if(!defined('FRAMEWORK_PATH')) { exit('FRAMEWORK_PATH not defined.'); } class db_mysql implements db_interface { private $conf; public $tablepre; public function __construct($conf) { $this->conf = $conf; $this->tablepre = $this->conf['master']['tablepre']; } public function __get($var) { $conf = $this->conf; if($var == 'rlink') { if(empty($this->conf['slaves'])) { $this->rlink = $this->wlink; return $this->rlink; } $n = rand(0, count($this->conf['slaves']) - 1); $conf = $this->conf['slaves'][$n]; $this->rlink = $this->connect($conf['host'], $conf['user'], $conf['password'], $conf['name'], $conf['charset'], $conf['engine']); return $this->rlink; } elseif($var == 'wlink') { $conf = $this->conf['master']; $this->wlink = $this->connect($conf['host'], $conf['user'], $conf['password'], $conf['name'], $conf['charset'], $conf['engine']); return $this->wlink; } } public function set($key, $data, $life = 0) { list($table, $keyarr, $sqladd) = $this->parse_key($key); $tablename = $this->tablepre.$table; if(is_array($data)) { $data += $keyarr; $s = ''; foreach($data as $k=>$v) { $v = addslashes($v); $s .= "$k='$v',"; } $s = substr($s, 0, -1); return $this->query("REPLACE INTO $tablename SET $s", $this->wlink); } else { return FALSE; } } public function get($key) { if(!is_array($key)) { list($table, $keyarr, $sqladd) = $this->parse_key($key); $tablename = $this->tablepre.$table; $result = $this->query("SELECT * FROM $tablename WHERE $sqladd", $this->rlink); return mysql_fetch_assoc($result); } else { $sqladd = $_sqladd = $table = $tablename = ''; $data = $return = $keyarr = array(); $keys = $key; foreach($keys as $key) { $return[$key] = array(); list($table, $keyarr, $_sqladd) = $this->parse_key($key); $tablename = $this->tablepre.$table; $sqladd .= "$_sqladd OR "; } $sqladd = substr($sqladd, 0, -4); if($sqladd) { $result = $this->query("SELECT * FROM $tablename WHERE $sqladd", $this->rlink); while($data = mysql_fetch_assoc($result)) { $keyname = $table; foreach($keyarr as $k=>$v) { $keyname .= "-$k-".$data[$k]; } $return[$keyname] = $data; } } return $return; } } public function delete($key) { list($table, $keyarr, $sqladd) = $this->parse_key($key); $tablename = $this->tablepre.$table; return $this->query("DELETE FROM $tablename WHERE $sqladd", $this->wlink); } public function maxid($key, $val = FALSE) { list($table, $col) = explode('-', $key); $maxid = $this->table_maxid($key); if($val === FALSE) { return $maxid; } elseif(is_string($val) && $val{0} == '+') { $val = intval($val); $this->query("UPDATE {$this->tablepre}framework_maxid SET maxid=maxid+'$val' WHERE name='$table'", $this->wlink); return $maxid += $val; } else { $this->query("UPDATE {$this->tablepre}framework_maxid SET maxid='$val' WHERE name='$table'", $this->wlink); return $val; } } public function native_maxid($table, $col) { $tablename = $this->tablepre.$table; $arr = $this->fetch_first("SELECT MAX($col) AS num FROM $tablename"); return isset($arr['num']) ? intval($arr['num']) : 0; } public function count($key, $val = FALSE) { $count = $this->table_count($key); if($val === FALSE) { return $count; } elseif(is_string($val)) { $count = $this->table_count($key); if($val{0} == '+') { $val = $count + abs(intval($val)); $this->query("UPDATE {$this->tablepre}framework_count SET count = '$val' WHERE name='$key'", $this->wlink); return $val; } else { $val = max(0, $count - abs(intval($val))); $this->query("UPDATE {$this->tablepre}framework_count SET count = '$val' WHERE name='$key'", $this->wlink); return $val; } } else { $this->query("UPDATE {$this->tablepre}framework_count SET count='$val' WHERE name='$key'", $this->wlink); return $val; } } public function native_count($table) { $tablename = $this->tablepre.$table; $arr = $this->fetch_first("SELECT COUNT(*) AS num FROM $tablename"); return isset($arr['num']) ? intval($arr['num']) : 0; } public function truncate($table) { $table = $this->tablepre.$table; try { $this->query("TRUNCATE $table"); return TRUE; } catch(Exception $e) { return FALSE; } } public function index_fetch($table, $keyname, $cond = array(), $orderby = array(), $start = 0, $limit = 0) { $keynames = $this->index_fetch_id($table, $keyname, $cond, $orderby, $start, $limit); if(!empty($keynames)) { return $this->get($keynames); } else { return array(); } } public function index_fetch_id($table, $keyname, $cond = array(), $orderby = array(), $start = 0, $limit = 0) { $tablename = $this->tablepre.$table; $keyname = (array)$keyname; $sqladd = implode(',', $keyname); $s = "SELECT $sqladd FROM $tablename"; if(!empty($cond)) { $s .= ' WHERE '; foreach($cond as $k=>$v) { if(!is_array($v)) { $v = addslashes($v); $s .= "$k = '$v' AND "; } else { foreach($v as $k1=>$v1) { $v1 = addslashes($v1); $k1 == 'LIKE' && $v1 = "%$v1%"; $s .= "$k $k1 '$v1' AND "; } } } $s = substr($s, 0, -4); } if(!empty($orderby)) { $s .= ' ORDER BY '; $comma = ''; foreach($orderby as $k=>$v) { $s .= $comma."$k ".($v == 1 ? ' ASC ' : ' DESC '); $comma = ','; } } $s .= ($limit ? " LIMIT $start, $limit" : ''); $return = array(); $result = $this->query($s, $this->rlink); while($data = mysql_fetch_assoc($result)) { $keyadd = ''; foreach($keyname as $k) { $keyadd .= "-$k-".$data[$k]; } $return[] = $table.$keyadd; } return $return; } public function fetch_first($sql) { $result = $this->query($sql, $this->rlink); return mysql_fetch_assoc($result); } public function index_create($table, $index) { $table = $this->tablepre.$table; $keys = implode(', ', array_keys($index)); $keyname = implode('', array_keys($index)); return $this->query("ALTER TABLE $table ADD INDEX $keyname($keys)"); } public function index_drop($table, $index) { $table = $this->tablepre.$table; $keys = implode(', ', array_keys($index)); $keyname = implode('', array_keys($index)); return $this->query("ALTER TABLE $table DROP INDEX $keyname"); } public function query($sql, $link = NULL) { empty($link) && $link = $this->wlink; defined('DEBUG') && DEBUG && isset($_SERVER['sqls']) && count($_SERVER['sqls']) < 1000 && $_SERVER['sqls'][] = htmlspecialchars(stripslashes($sql)); $result = mysql_query($sql, $link); if(!$result) { throw new Exception(self::br('MySQL Query Error:'.$sql.'. '.mysql_error())); } return $result; } private function connect($host, $user, $password, $name, $charset, $engine) { $link = mysql_connect($host, $user, $password, $name); if(!$link) { throw new Exception(self::br(mysql_error())); } $bool = mysql_select_db($name, $link); if(!$bool) { throw new Exception(self::br(mysql_error())); } if(!empty($engine) && $engine == 'InnoDB') { $this->query("SET innodb_flush_log_at_trx_commit=no", $link); } if($charset) { $this->query("SET character_set_connection=utf8, character_set_results=utf8, character_set_client=binary, sql_mode=''", $link); } return $link; } private function result($query, $row) { return mysql_num_rows($query) ? intval(mysql_result($query, $row)) : 0; } private function table_count($key) { $count = 0; $query = mysql_query("SELECT count FROM {$this->tablepre}framework_count WHERE name='$key'", $this->rlink); if($query) { $count = $this->result($query, 0); } elseif(mysql_errno($this->rlink) == 1146) { $this->query("CREATE TABLE {$this->tablepre}framework_count (
				`name` char(32) NOT NULL default '',
				`count` int(11) unsigned NOT NULL default '0',
				PRIMARY KEY (`name`)
				) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci"); } else { throw new Exception('framework_cout 错误, mysql_error:'.mysql_error()); } if(empty($count)) { $this->query("REPLACE INTO {$this->tablepre}framework_count SET name='$key', count='0'", $this->wlink); } return $count; } private function table_maxid($key) { list($table, $col) = explode('-', $key); $maxid = 0; $query = mysql_query("SELECT maxid FROM {$this->tablepre}framework_maxid WHERE name='$table'", $this->rlink); if($query) { $maxid = $this->result($query, 0); } elseif(mysql_errno($this->rlink) == 1146) { $this->query("CREATE TABLE `{$this->tablepre}framework_maxid` (
				`name` char(32) NOT NULL default '',
				`maxid` int(11) unsigned NOT NULL default '0',
				PRIMARY KEY (`name`)
				) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci"); } else { throw new Exception("{$this->tablepre}framework_maxid 错误, mysql_errno:".mysql_errno().', mysql_error:'.mysql_error()); } if(empty($maxid)) { $query = $this->query("SELECT MAX($col) FROM {$this->tablepre}$table", $this->rlink); $maxid = $this->result($query, 0); $this->query("REPLACE INTO {$this->tablepre}framework_maxid SET name='$table', maxid='$maxid'", $this->wlink); } return $maxid; } public static function br($s) { if(!core::is_cmd()) { return nl2br($s); } else { return $s; } } private function parse_key($key) { $sqladd = ''; $arr = explode('-', $key); $len = count($arr); $keyarr = array(); for($i = 1; $i < $len; $i = $i + 2) { if(isset($arr[$i + 1])) { $sqladd .= ($sqladd ? ' AND ' : '').$arr[$i]."='".addslashes($arr[$i + 1])."'"; $t = $arr[$i + 1]; $keyarr[$arr[$i]] = is_numeric($t) ? intval($t) : $t; } else { $keyarr[$arr[$i]] = NULL; } } $table = $arr[0]; if(empty($table)) { throw new Exception("parse_key($key) failed, table is empty."); } if(empty($sqladd)) { throw new Exception("parse_key($key) failed, sqladd is empty."); } return array($table, $keyarr, $sqladd); } public function __destruct() { if(!empty($this->wlink)) { mysql_close($this->wlink); } if(!empty($this->rlink) && !empty($this->wlink) && $this->rlink != $this->wlink) { mysql_close($this->rlink); } } public function version() { return mysql_get_server_info($this->rlink); } } ?><?php
 if(!defined('FRAMEWORK_PATH')) { exit('FRAMEWORK_PATH not defined.'); } class db_mongodb implements db_interface { private $conf; private $dbname; public function __construct($conf) { $this->conf = $conf; $this->dbname = $conf['master']['name']; if(!extension_loaded('Mongo')) { throw new Exception('Mongo Extension not loaded.'); } } public function __get($var) { $conf = $this->conf; if($var == 'rlink') { if(empty($this->conf['slaves'])) { $this->rlink = $this->wlink; } else { $n = rand(0, count($this->conf['slaves']) - 1); $conf = $this->conf['slaves'][$n]; $this->rlink = $this->connect($conf['host'], $conf['user'], $conf['password'], $conf['name']); } return $this->rlink; } elseif($var == 'wlink') { $conf = $this->conf['master']; $this->wlink = $this->connect($conf['host'], $conf['user'], $conf['password'], $conf['name']); return $this->wlink; } elseif($var == 'wdb') { $this->wdb = $this->wlink->selectDB($conf['master']['name']); return $this->wdb; } elseif($var == 'rdb') { if(empty($this->conf['slaves'])) { $this->rdb = $this->wdb; } else { $this->rdb = $this->rlink->selectDB($conf['master']['name']); } return $this->rdb; } } public function set($key, $data, $life = 0) { list($table, $keyarr, $sqladd) = $this->parse_key($key); if(is_array($data)) { $coll = $this->wdb->selectCollection($table); $data += $keyarr; } else { throw new Exception('set data must be a array.'); } if(!$this->get($key)) { $this->debug('insert', $key, $data); $coll->insert($data); } else { unset($data['_id']); $this->debug('update', $key, $data); $coll->update($keyarr, array('$set' => $data)); } return TRUE; } public function get($key) { if(!is_array($key)) { list($table, $keyarr, $sqladd) = $this->parse_key($key); $coll = $this->wdb->selectCollection($table); $data = $coll->findOne($keyarr); $this->debug('findOne', $key, $data); return $data; } else { $return = array(); foreach($key as $k) { $return[$k] = $this->get($k); } return $return; } } public function delete($key) { list($table, $keyarr, $sqladd) = $this->parse_key($key); $coll = $this->wdb->selectCollection($table); $this->debug('delete', $key, array()); return $coll->remove($keyarr, true); } public function maxid($key, $val = FALSE) { $key = 'framework_maxid-'.str_replace('-', '_', $key); $maxid = $this->get($key); $maxid = $maxid['data']; if($val === FALSE) { return intval($maxid); } elseif(is_string($val) && $val{0} == '+') { $val = intval($val) + $maxid; $this->set($key, array('data'=>$val)); return $val; } else { $this->set($key, array('data'=>$val)); return $val; } } public function native_maxid($table, $col) { $coll = $this->rdb->selectCollection($table); $cursor = $coll->find(array(), array("$col"=>1))->sort(array("$col"=>-1))->limit(1); $arr = $cursor->getNext(); return empty($arr["$col"]) ? intval($arr["$col"]) : 0; } public function count($key, $val = FALSE) { $key = 'framework_count-'.str_replace('-', '_', $key); $count = $this->get($key); $count = $count['data']; if($val === FALSE) { return $count; } elseif(is_string($val)) { if($val{0} == '+') { $val = intval($val); $count = max(0, intval($key) + $val); $this->set($key, array('data'=>$count)); return $count; } else { $val = abs(intval($val)); $count = max(0, intval($count) - $val); $this->set($key, array('data'=>$count)); return $count; } } else { $this->set($key, array('data'=>$val)); return $val; } } public function native_count($table) { $coll = $this->rdb->selectCollection($table); return intval($coll->count()); } public function truncate($table) { return $this->wdb->selectCollection($table)->drop(); } public function index_fetch_id($table, $keyname, $cond = array(), $orderby = array(), $start = 0, $limit = 0) { $ids = array(); $keyname = (array)$keyname; $arrlist = $this->index_fetch($table, $keyname, $cond, $orderby, $start, $limit); if(!empty($arrlist)) { foreach($arrlist as $k=>$arr) { $ids[] = $k; } } return $ids; } public function index_fetch($table, $keyname, $cond = array(), $orderby = array(), $start = 0, $limit = 0) { $coll = $this->rdb->selectCollection($table); $return = array(); foreach($cond as &$v) { if(is_array($v)) { foreach($v as $k1=>$v1) { unset($v[$k1]); $k1 = str_replace(array('>', '>=', '<', '<=', 'LIKE'), array('$gt', '$gte', '$lt', '$lte', '$regex'), $k1); $v[$k1] = $v1; } } } if($limit) { $cursor = $coll->find($cond)->sort($orderby)->skip($start)->limit($limit); } else { $cursor = $coll->find($cond)->sort($orderby); } $this->debug('find', $table, $cond); while($cursor->hasNext()) { $data = $cursor->getNext(); $keyadd = ''; foreach($keyname as $k) { $keyadd .= "-$k-".$data[$k]; } $key = $table.$keyadd; $return[$key] = $data; } return $return; } public function index_create($table, $index) { $coll = $this->wdb->selectCollection($table); return $coll->ensureIndex($index); } public function index_drop($table, $index) { $coll = $this->wdb->selectCollection($table); return $coll->deleteIndex($index); } private function connect($host, $user, $password, $name) { $useradd = empty($user) ? '' : "$user:$password@"; try { $link = new Mongo("mongodb://{$useradd}$host/", array("persist"=>"onename", 'timeout'=>100)); } catch(Exception $e) { throw new Exception('不能连接到 Mongodb 服务器，Error:'.$e->getMessage()); exit; } return $link; } private function parse_key($key) { $sqladd = ''; $arr = explode('-', $key); $len = count($arr); $keyarr = array(); for($i = 1; $i < $len; $i = $i + 2) { if(isset($arr[$i + 1])) { $sqladd .= ($sqladd ? ' AND ' : '').$arr[$i]."='".addslashes($arr[$i + 1])."'"; $t = $arr[$i + 1]; $keyarr[$arr[$i]] = is_numeric($t) ? intval($t) : $t; } else { $keyarr[$arr[$i]] = NULL; } } $table = $arr[0]; if(empty($table)) { throw new Exception("parse_key($key) failed, table is empty."); } return array($table, $keyarr, $sqladd); } public function __destruct() { if(!empty($this->wlink)) { $this->wlink->close(); } if(!empty($this->rlink) && $this->rlink != $this->wlink) { $this->rlink->close(); } } private function debug($operation, $key, $data) { if(defined('DEBUG') && DEBUG && isset($_SERVER['sqls']) && count($_SERVER['sqls']) < 1000) { $s = "$operation $key  array("; if(!empty($data)) { foreach($data as $k=>$v) {$s .= "'$k'=>".(is_string($v) ? "'$v'" : $v).", ";} $s = substr($s, 0, -2).')'; } $s .= ')'; $_SERVER['sqls'][] = htmlspecialchars(stripslashes($s)); } } public function version() { return ''; } } ?><?php
 if(!defined('FRAMEWORK_PATH')) { exit('FRAMEWORK_PATH not defined.'); } class cache_memcache implements cache_interface { public $conf; public function __construct($conf) { $this->conf = $conf; } private $support_getmulti; public function __get($var) { if($var == 'memcache') { if(extension_loaded('Memcached')) { $this->memcache = new Memcached; } elseif(extension_loaded('Memcache')) { $this->memcache = new Memcache; } else { throw new Exception('Memcache Extension not loaded.'); } if(!$this->memcache) { throw new Exception('PHP.ini Error: Memcache extension not loaded.'); } if($this->memcache->connect($this->conf['host'], $this->conf['port'])) { return $this->memcache; } else { throw new Exception('Can not connect to Memcached host.'); } $this->support_getmulti = $this->conf['multi'] || method_exists($this->memcache, 'getMulti'); } } public function set($key, $value, $life = 0) { return $this->memcache->set($key, $value, 0, $life); } public function get($key) { $data = array(); if(is_array($key)) { if($this->support_getmulti) { return $this->memcache->getMulti($key); } else { foreach($key as $k) { $arr = $this->memcache->get($k); $arr && $data[$k] = $arr; } return $data; } } else { $data = $this->memcache->get($key); return $data; } } public function delete($key) { return $this->memcache->delete($key); } public function flush() { return $this->memcache->flush(); } public function maxid($table, $val = FALSE) { $key = $table.'-Auto_increment'; if($val === FALSE) { return intval($this->get($key)); } elseif(is_string($val) && $val{0} == '+') { $val = intval($val); $val += intval($this->get($key)); $this->set($key, $val); return $val; } else { $this->set($key, $val); return $val; } } public function count($table, $val = FALSE) { $key = $table.'-Rows'; if($val === FALSE) { return intval($this->get($key)); } elseif(is_string($val)) { if($val{0} == '+') { $val = intval($val); $n = intval($this->get($key)) + $val; $this->set($key, $n); return $n; } else { $val = abs(intval($val)); $n = max(0, intval($this->get($key)) - $val); $this->set($key, $n); return $n; } } else { $this->set($key, $val); return $val; } } } ?>