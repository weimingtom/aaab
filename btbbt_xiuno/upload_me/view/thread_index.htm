<!--{include header.htm}-->

<!--{hook thread_index_start.htm}-->

<div class="width">

	<!--{hook thread_index_nav_before.htm}-->
	<table id="nav" cellpadding="0" cellspacing="0" style="margin-bottom: 4px;">
		<tr>
			<td class="left"></td>
			<td class="center">
				<a class="icon icon-home" href="./"></a>
				<span class="sep"></span>
				<a href="?index-forum-fid-$pforum[fid].htm" id="pforum_link">$pforum[name]</a>
				<span class="sep"></span>
				<span><a href="?forum-index-fid-$fid-page-1.htm" id="forum_link">$forum[name]</a></span>
				<span class="sep"></span>
				<span>$thread[subject]</span>
				<!--{hook thread_index_nav_end.htm}-->
			</td>
			<!--{hook thread_index_nav_td_1_after.htm}-->
			<td width="160" align="right">
				<input type="button" value=" 回帖 " class="button smallblue ajaxdialog" href="?post-post-fid-$fid-tid-$tid-ajax-1.htm" ajaxdialog="{fullicon: true, cache: true}" onclick="return false;" id="create_post" />
				<input type="button" value=" 发新帖 " class="button smallblue ajaxdialog" href="?post-thread-fid-$fid-ajax-1.htm" ajaxdialog="{fullicon: true, cache: true}" onclick="return false;" id="create_thread" />
			</td>
			<!--{hook thread_index_nav_td_2_after.htm}-->
			<td class="right"></td>
		</tr>
	</table>
	
	<!--{hook thread_index_nav_after.htm}-->
	
	<!--{loop $postlist $post}-->
	<!--{php $u = isset($userlist[$post['uid']]) ? $userlist[$post['uid']] : array('uid'=>0, 'username'=>'', 'groupname'=>'', 'avatar_big'=>'', 'signature'=>'', );}-->
	<table border="0" cellpadding="0" cellspacing="0" width="100%" align="center" style="margin-top: 4px; margin-bottom: 8px; table-layout: fixed;">
		<tr>
			<!--{hook thread_index_post_td_1_before.htm}-->
			<td width="154" valign="top">
				<div class="bg2 border shadow" style="width: 120px; padding: 15px; padding-top: 4px; padding-bottom: 4px;">
					<p>
						<a href_real="?you-index-uid-$u[uid].htm" target="_blank" href="?you-profile-uid-$u[uid]-ajax-1.htm" class="ajaxdialog_hover" ajaxdialog="{position: 5, modal: false, timeout: 1000, showtitle: false}" onclick="return false;" style="display: block" rel="nofollow">
							<span class="avatar_big border bg1" {if $u[avatar_big]}style="background-image: url($u[avatar_big])"{/if}></span>
						</a>
					</p>
					<p><b>$u[username]</b></p>
					<p style="margin-top: 0px;">$u[groupname]</p>
					<div class="userinfo_dl grey">
						<!--{hook thread_index_userinfo.htm}-->
					</div>
				</div>
			</td>
			<!--{hook thread_index_post_td_1_after.htm}-->
			<td width="15"></td>
			<!--{hook thread_index_post_td_2_after.htm}-->
			<td class="post_td" valign="top">
				<span class="icon icon-left-arrow" style="position: absolute; z-index: 9; float: left; margin-left: -9px; margin-top: 10px;"></span>
				<div class="bg1 border shadow post" style="padding: 8px;">
				
					<!--{if $thread[firstpid] == $post[pid]}-->
					<h2 id="subject_$tid" style="margin-top: 0px;"{if $thread[digest]} class="digest_$thread[digest]"{/if}>
						<!--{if $thread[top]}-->
						<span class="icon icon-top-$thread[top]" style="margin-right: 2px;" title="置顶主题"></span>
						<!--{/if}-->
						
						<!--{if $thread[digest]}-->
						<span class="icon icon-digest-$thread[digest]" style="margin-right: 2px;" title="精华主题"></span>
						<!--{loop $thread[catelist_full] $cateid $catename}-->
						<a href="?digest.htm#$cateid-$thread[fid]-$thread[tid]" target="_blank" class="small{if $thread[digest]} digest_$thread[digest]{/if}">[$catename]</a>
						<!--{/loop}-->
						<!--{/if}-->
						
						 <!--{if $thread[typeid]}-->
						 [<a href="?forum-index-fid-$fid-typeid-$thread[typeid].htm" target="_blank">$thread[typename]</a>]
					 	<!--{/if}-->
					 	
						$thread[subject]
						
						<span class="small grey" style="font-weight: normal;">(回复:$thread[posts_fmt] 查看:<span id="thread_views">$thread[views]</span>)</span>
						
						<!--{hook thread_index_subject_end.htm}-->
					</h2>
					<!--{/if}-->
					
					<div style="font-size: 14px;" id="message_$post[pid]">$post[message] <!--{hook thread_index_message_end.htm}--><span class="small grey"> ($post[dateline])</span> </div>
					
					<!--{hook thread_index_message_after.htm}-->
					
					<!--{if !empty($post[attachlist])}-->
					<ul class="attachlist">
					<!--{loop $post[attachlist] $attach}-->
						<li>
							<a href="?attach-dialog-aid-$attach[aid]-ajax-1.htm" class="ajaxdialog" ajaxdialog="{showtitle: false, cache: true, position: 6, modal: false}" onclick="return false;" target="_blank" rel="nofollow"><img src="view/image/filetype/$attach[filetype].gif" width="16" height="16" />$attach[orgfilename]</a>
							<span class="grey small"> / $attach[filesize_fmt] $attach[dateline_fmt] 下载{$attach[downloads]}次</span>
						</li>
					<!--{/loop}-->
					</ul>
					<!--{/if}-->
					
					<!--{hook thread_index_attachlist_after.htm}-->
					
					<div class="grey signature" style="display: none; overflow: hidden; {if !$u[signature]}background: none; padding-top: 0px;{/if}">
					<span style="float: left"><!--{if $u[signature]}-->$u[signature]<!--{else}-->&nbsp;<!--{/if}--></span>
					<span style="margin-left: 4px; width: 145px; float: right; text-align: right;">
							<!--{if $ismod || $_user[uid] == $post[uid]}-->	
							<a href="?post-update-fid-$thread[fid]-pid-$post[pid]-ajax-1.htm" class="ajaxdialog" ajaxdialog="{fullicon: true, modal: false, cache: false}" onclick="return false;"><span class="icon icon-post-update" style="vertical-align: bottom; margin-bottom: -2px; margin-right: 2px;"></span>编辑</a> <a href="?post-delete-fid-$fid-pid-$post[pid].htm" onclick="return window.confirm('您确定删除吗？');"><span class="icon icon-post-delete" style="vertical-align: bottom; margin-bottom: -2px;"></span>删除</a>
							<!--{/if}-->
							#$post[floor]楼
						<span>
						
					</div>
				</div>
			</td>
			<!--{hook thread_index_post_td_3_after.htm}-->
		</tr>
	</table>
	<!--{/loop}-->
	
	<!--{hook thread_index_reply_before.htm}-->
	<table border="0" cellpadding="0" cellspacing="0" width="100%" align="center" style="margin-top: 4px;">
		<tr>
			<!--{hook thread_index_reply_td_1_before.htm}-->
			<td width="150" valign="top">
				<div class="bg2 border shadow" style="width: 120px; padding: 15px; padding-top: 4px; padding-bottom: 4px;">
					<p>
						<a href_real="?you-index-uid-$_user[uid].htm" target="_blank" href="?you-profile-uid-$_user[uid]-ajax-1.htm" class="ajaxdialog_hover" ajaxdialog="{position: 5, modal: false, timeout: 1000, showtitle: false}" onclick="return false;" style="display: block" rel="nofollow">
							<span class="avatar_big border bg1" {if !empty($_user[avatar_big])}style="background-image: url($_user[avatar_big])"{/if}></span>
						</a>
					</p>
					<p><b>$_user[username]</b></p>
					<p>$_user[groupname]</p>
				</div>
			</td>
			<!--{hook thread_index_reply_td_1_after.htm}-->
			<td width="15"></td>
			<!--{hook thread_index_reply_td_2_after.htm}-->
			<td class="post_td" valign="top">
				<span class="icon icon-left-arrow" style="position: absolute; z-index: 9; float: left; margin-left: -9px; margin-top: 10px;"></span>
				<div class="bg1 border shadow" style="padding: 8px;">
					<form action="?post-post-fid-$thread[fid]-tid-$thread[tid]-ajax-1-quickpost-1.htm" method="post" id="quick_post_form" target="_blank">
						<input type="hidden" name="FORM_HASH" value="{FORM_HASH}" />
						<textarea name="message" id="quick_message" style="width: 100%; height: 128px; font-size: 14px; overflow: hidden;"></textarea>
						<!--{hook thread_index_17.htm}-->
						<div style="margin-top: 4px;"><input type="submit" class="button smallblue" id="quick_post_submit" value="快速回复" /></div>
					</form>
				</div>
			</td>
			<!--{hook thread_index_reply_td_3_after.htm}-->
		</tr>
	</table>
	<!--{hook thread_index_reply_after.htm}-->
	
	<div class="box">
		<div class="page" style="text-align: center;">$pages</div>
		<!--{if $ismod}-->
		<div style="text-align: center;">
			<input type="checkbox" name="tidarr[]" value="$thread[fid]-$thread[tid]" checked="checked" />
			<input type="button" class="button smallblue" id="mod_top"  value="置顶" />
			<!--{if $forum[typelist]}-->
			<input type="button" class="button smallblue" id="mod_type"  value="主题分类" />
			<!--{/if}-->
			<input type="button" class="button smallblue" id="mod_digest"  value="精华分类" />
			<input type="button" class="button smallblue" id="mod_move"  value="移动" />
			<input type="button" class="button smallblue" id="mod_delete"  value="删除" />
			<!--{hook thread_index_mod_end.htm}-->
		</div>
		<!--{/if}-->
		<p style="text-align: center; padding: 8px;"><input type="button" value=" 返回 " class="button bigblue" onclick="history.back()" /></p>
	</div>
	
	<!--{hook thread_index_mod_after.htm}-->
	
</div>

<!--{include footer.htm}-->

<!--{if $ismod}-->
<script type="text/javascript">
// copy from forum_index.htm
var sep = $conf[urlrewrite] ? '?' : '&';

// 置顶 弹出 dialog 设置为置顶
$('#mod_top').click(function() {
	var postdata = sep;
	$.each($('#body input[name="tidarr[]"]:checked'), function(k, v) {
		postdata += '&tidarr[]='+v.value;
	});
	ajaxdialog_request('?mod-top-fid-$fid.htm'+postdata, function() {
		window.location.reload();
	});
});

// 精华
$('#mod_digest').click(function() {
	var postdata = sep;
	$.each($('#body input[name="tidarr[]"]:checked'), function(k, v) {
		postdata += '&tidarr[]='+v.value;
	});
	ajaxdialog_request('?mod-digest-fid-$fid.htm'+postdata, function() {
		window.location.reload();
	});
});

// 主题分类 
$('#mod_type').click(function() {
	var postdata = sep;
	$.each($('#body input[name="tidarr[]"]:checked'), function(k, v) {
		postdata += '&tidarr[]='+v.value;
	});
	ajaxdialog_request('?mod-type-fid-$fid.htm'+sep+postdata, function() {
		window.location.reload();
	});
});

// 删除
$('#mod_delete').click(function() {
	var postdata = sep;
	$.each($('#body input[name="tidarr[]"]:checked'), function(k, v) {
		postdata += '&tidarr[]='+v.value;
	});
	ajaxdialog_request('?mod-delete-fid-$fid.htm'+postdata, function() {
		window.location.reload();
	});
});

// 删除
$('#mod_move').click(function() {
	var postdata = sep;
	$.each($('#body input[name="tidarr[]"]:checked'), function(k, v) {
		postdata += '&tidarr[]='+v.value;
	});
	ajaxdialog_request('?mod-move-fid-$fid.htm'+postdata, function() {
		window.location.reload();
	});
});

</script>
<!--{/if}-->

<script type="text/javascript">

// 数据格式： {tids:{"2012-1-12":[1 2 3 4],"2012-1-13":[5 6 7 8]},fids:{1:1234567890,2:1234567890}}
tid_add_read($tid);
fid_update_lasttime($fid, $_SERVER[time]);
//$.pdata(cookiepre + 'readtids', '');
//alert($.pdata(cookiepre + 'readfids'));
//alert($.pdata(cookiepre + 'readtids'));

// 登陆后才能发帖
{if $_user[uid] == 0}
$('#create_thread').click(function() {
	ajaxdialog_request('?user-login-ajax-1.htm', function() {
		$('#create_thread').unbind('click');
		ajaxdialog_request($('#create_thread').attr('href'));
		$('#create_thread').click(function() {
			ajaxdialog_request($('#create_thread').attr('href'));
		});
	});
	return false;
});
{/if}

// 发帖按钮，判断未登录状态
{if $_user[uid] == 0}
$('#create_post').click(function() {
	ajaxdialog_request('?user-login-ajax-1.htm', function() {
		$('#create_post').unbind('click');
		ajaxdialog_request($('#create_post').attr('href'));
		$('#create_post').click(function() {
			ajaxdialog_request($('#create_post').attr('href'));
		});
	});
	return false;
});
{/if}

// 点击数服务器
$.getScript('$click_server&'+Math.random(), function() {
	if(typeof xn_json == 'undefined') return;
	var json = xn_json;
	$('#thread_views').html(json['$tid']);
});

// 自动伸缩，自动提交
$('#quick_message').keyup(function(e) {
	if(e.ctrlKey && e.which == 13 || e.which == 10) {
		$('#quick_post_submit').trigger('click');
		return false;
	}
        
	var h = $(this)[0].scrollHeight;
	if(h <= 100) {
		return true;
	} else {
		$(this).height($(this)[0].scrollHeight);
		return true;
	}
});

// 快速回复
$('#quick_post_submit').click(function() {
	if(!$('#quick_message').val()) {
		$('#quick_message').alert('请填写内容！', {width: 150, delay: 3000}).focus();
		return false;
	}
	
{if $_user[uid] == 0}
	ajaxdialog_request('?user-login-ajax-1.htm', function() {
{/if}

	var postdata = $("#quick_post_form").serialize();
	$.post($('#quick_post_form').attr('action'), postdata,  function(s){
		var json = json_decode(s);
		if(error = json_error(json)) {alert(error); return false;}
		if(json.status <= 0) {
			json = json.message;
			if(json.message) {
				$('#quick_message').alert(json.message, {width: 150, delay: 3000}).focus();
				return false;
			}
		} else {
			// hook thread_index_post_succeed_js.htm
			var page = Math.max(1, to_int(json.page));
			window.location= '?thread-index-fid-$fid-tid-$tid-page-'+page+'-scrollbottom-1.htm';
		}
	});
	return false;
	
{if $_user[uid] == 0}
	});
{/if}

});

// 滚动回复的到最底部
{if $scrollbottom}
var offset = $('#quick_message').offset();
document.documentElement.scrollTop = offset.top - 300;
$('#quick_message').focus();
{/if}

// 记录当前页码
var fid_page = $.parseJSON($.pdata(cookiepre + 'fid_page'));
var page = fid_page ? fid_page[''+$fid] : '';
if(page && page > 1) {
	var href = $('#pforum_link').attr('href').replace(/page-1/ig, "page-"+page);
	$('#pforum_link').attr('href', href);
	
	var href = $('#forum_link').attr('href').replace(/page-1/ig, "page-"+page);
	$('#forum_link').attr('href', href);
}

// 鼠标放在头像上弹出用户信息 ajaxdialog_hover
var jajaxdialoglinks = $('a.ajaxdialog_hover');
jajaxdialoglinks.die('click').live('click', function() {window.open($(this).attr('href_real'))});
jajaxdialoglinks.die('mouseover').live('mouseover', ajaxdialog_mouseover);
jajaxdialoglinks.die('mouseout').live('mouseout', ajaxdialog_mouseout);

// post_td 下的图片调整大小
$(function() {
	var td_width = $('td.post_td').width() - 16;
	td_width = Math.min($('#body').width() - 202, td_width);
	$('td.post_td img').each(function() {
		if($(this).width() > td_width) {
			this.height = Math.ceil((this.height /this.width) * td_width);
			this.width = Math.ceil(td_width);
			
			this.style.cursor = 'pointer';
			this.onclick = function() {
				window.open(this.src);
			}
		}
	});
});

// 调整签名的位置
$('div.signature').each(function() {
	// 计算到父容器的的距离
	var ph = $(this).parent().height();
	var h = $(this).height();
	var ppos = $(this).parent().offset();
	var pos = $(this).show().offset();
	//alert('pos.top' + pos.top + ', ppos.top:'+ ppos.top + ', ph:' + ph + ', h:'+h);
	if(pos.top - ppos.top < ph - h) {
		$(this).css('margin-top', (ph - (pos.top - ppos.top) - 13) + 'px');
	}
});

bind_document_keyup_page();

</script>

<script>
if($('pre').length > 0) {
	xiuno_load_css('view/js/syntaxlighter/syntax.css');
	$.xload('view/js/syntaxlighter/syntax.js', function() {
		SyntaxHighlighter.all();
	});
}
</script>

<!--{hook thread_index_end.htm}-->

$conf[footer_js]

</body>

</html>